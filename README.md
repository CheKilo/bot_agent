# Bot Agent

基于 Go + Python 的 AI Agent 系统，支持多轮对话、多Agent协作、三层记忆管理、人设情感等能力。

---

## 设计理念

- **Go + Python 双语言架构**：Go 负责高性能 gRPC 服务（LLM 代理 + 存储），Python 负责 HTTP 入口、AI 推理与 Agent 逻辑
- **三 Agent 协作**：System Agent（输入输出检测 + 调度） + Memory Agent（记忆管理） + Character Agent（人设回复）
- **三层记忆系统**：短期（滑动窗口）→ 中期（MySQL摘要）→ 长期（Milvus向量）
- **分层模型策略**：不同 Agent 使用不同规模的 LLM，平衡效果与成本

---

## 技术选型

| 层级 | 技术 | 职责 |
|-----|------|------|
| HTTP API | Python (FastAPI) | HTTP 入口、请求处理 |
| gRPC Services | Go | LLM 代理、存储服务封装 |
| AI Agent | Python | 多Agent协作、LLM调用、记忆管理 |
| 通信协议 | gRPC + Protobuf | 服务间高效通信 |
| 存储 | MySQL + Milvus Lite | 结构化存储 + 向量检索 |
| LLM | 内部代理接口 | 支持多模型配置 |

---

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                              客户端                                  │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │ HTTP
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Python API (FastAPI)                            │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │                      System Agent                            │  │
│   │                 （输入输出检测 + 调度中心）                     │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│              ┌───────────────┴───────────────┐                      │
│              ▼                               ▼                      │
│   ┌──────────────────────┐      ┌──────────────────────┐           │
│   │    Memory Agent      │      │   Character Agent    │           │
│   │   （三级记忆管理）    │      │   （人设回复生成）    │           │
│   └──────────────────────┘      └──────────────────────┘           │
│                                                                     │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │ gRPC
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Go gRPC Services                                 │
│  ┌─────────────────────────┐  ┌─────────────────────────────────┐  │
│  │       llmproxy          │  │            storage              │  │
│  │     LLM 代理服务        │  │       MySQL / Milvus Lite       │  │
│  └─────────────────────────┘  └─────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 三层记忆系统

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Memory Agent 三级记忆架构                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │               短期记忆 (Short-term)                            │ │
│  │  • 存储：内存滑动窗口（20条消息）                               │ │
│  │  • 访问：直接携带在对话上下文中                                 │ │
│  └───────────────────────────┬───────────────────────────────────┘ │
│                              │ 窗口满时触发摘要                      │
│                              ▼                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │               中期记忆 (Mid-term)                              │ │
│  │  • 存储：MySQL（LLM 生成的摘要 + 关键词）                       │ │
│  │  • 访问：最近 N 条自动携带 + 工具检索                           │ │
│  │  • 检索：BM25 粗排 → 多因子精排                                 │ │
│  └───────────────────────────┬───────────────────────────────────┘ │
│                              │ 高频访问自动提升                      │
│                              ▼                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │               长期记忆 (Long-term)                             │ │
│  │  • 存储：Milvus 向量数据库                                      │ │
│  │  • 访问：工具检索（语义向量相似度）                             │ │
│  │  • 来源：Agent 主动存储 / 中期记忆提升                          │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

| 层级 | 存储 | 容量 | 访问方式 |
|-----|------|------|----------|
| 短期记忆 | 内存 | 20条消息 | 自动携带 |
| 中期记忆 | MySQL | 无限制 | 最近N条自动携带 + 工具检索 |
| 长期记忆 | Milvus | 无限制 | 工具检索 |

### Memory Agent 工具

| 工具名 | 功能 |
|--------|------|
| `search_mid_term_memory` | 检索中期记忆（历史对话摘要） |
| `search_long_term_memory` | 检索长期记忆（重要信息） |
| `store_long_term_memory` | 存储长期记忆 |

---

## 多Agent协作流程

```
用户输入
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│  System Agent                                                    │
│  • 输入敏感检测                                                   │
│  • 调度 Memory Agent 和 Character Agent                          │
│  • 输出敏感检测                                                   │
└─────────────────────────────────────────────────────────────────┘
    │
    ├──────────────────────────────────┐
    ▼                                  ▼
┌─────────────────────┐     ┌─────────────────────┐
│   Memory Agent      │     │  Character Agent    │
│                     │     │                     │
│  • 自主判断是否检索  │ ───►│  • 加载人设配置     │
│  • 返回记忆上下文    │记忆 │  • 维护情感状态     │
│                     │上下文│  • 生成最终回复     │
└─────────────────────┘     └─────────────────────┘
                                   │
                                   ▼
                              最终输出
```

---

## 目录结构

```
bot_agent/
├── gateway/                    # [Go] gRPC 服务
│   ├── cmd/server/             # 启动入口
│   └── internal/
│       ├── llmproxy/           # LLM 代理服务
│       └── storage/            # 存储服务
│
├── api/                        # [Python] HTTP API 入口
│   └── main.py                 # FastAPI 启动入口
│
├── agent/                      # [Python] Multi-Agent 核心
│   ├── agents/
│   │   ├── base.py             # Agent 基类（ReAct 循环）
│   │   ├── system/             # System Agent
│   │   ├── memory/             # Memory Agent
│   │   └── character/          # Character Agent
│   │
│   ├── tools/                  # 工具基础设施
│   ├── core/                   # 核心基础设施（LLM 调用等）
│   └── client/                 # gRPC 客户端
│
├── proto/                      # gRPC 协议定义
├── config/                     # 全局配置
└── deploy/                     # 部署相关
```

---

## 数据流

```
用户请求
    │
    ▼
[Python API] HTTP 入口
    │
    ▼
[System Agent] 输入检测 → [Memory Agent] 记忆检索 → [Character Agent] 回复生成
    │                          │                          │
    │                          ▼                          ▼
    │                    gRPC → Storage            gRPC → LLMProxy
    │                    (MySQL/Milvus)            (内部 LLM API)
    │
    ▼
[System Agent] 输出检测
    │
    ▼
返回用户
```

---

## 服务职责

| 服务 | 语言 | 职责 |
|-----|------|------|
| Python API | Python | HTTP 入口、请求路由 |
| System Agent | Python | 输入/输出检测、Agent 调度 |
| Memory Agent | Python | 三级记忆管理、自主检索 |
| Character Agent | Python | 人设、情感、回复生成 |
| Go LLMProxy | Go | 封装内部 LLM API |
| Go Storage | Go | MySQL/Milvus 操作封装 |

---

## License

MIT
